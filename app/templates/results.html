{% extends "base.html" %}

{% block app_content %}
<h1>Your Application Results</h1>

{% if applications %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Date</th>
                <th>Industry</th>
                <th>Experience</th>
                <th>Education</th>
                <th>Skills</th>
                <th>Success Probability</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for app in applications %}
            <tr>
                <td>{{ app.created_at.strftime('%Y-%m-%d') }}</td>
                <td>{{ app.industry_type }}</td>
                <td>{{ app.years_experience }} years</td>
                <td>
                    {% if app.education_level == 1 %}High School
                    {% elif app.education_level == 2 %}Associate Degree
                    {% elif app.education_level == 3 %}Bachelor Degree
                    {% elif app.education_level == 4 %}Master Degree
                    {% else %}PhD
                    {% endif %}
                </td>
                <td>{{ app.num_skills }}</td>
                <td>
                    <div class="progress">
                        <div class="progress-bar {% if app.success_probability > 0.7 %}bg-success
                                               {% elif app.success_probability > 0.4 %}bg-warning
                                               {% else %}bg-danger{% endif %}"
                             role="progressbar"
                             style="width: {{ app.success_probability * 100 }}%"
                             aria-valuenow="{{ app.success_probability * 100 }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            {{ "%.1f"|format(app.success_probability * 100) }}%
                        </div>
                    </div>
                </td>
                <td>
                    {% if app.is_successful is none %}
                    <span class="badge badge-secondary">Pending</span>
                    {% elif app.is_successful %}
                    <span class="badge badge-success">Successful</span>
                    {% else %}
                    <span class="badge badge-danger">Unsuccessful</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Success Rate Analysis</h5>
                <canvas id="successRateChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Industry Distribution</h5>
                <canvas id="industryChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-info">
    You haven't submitted any applications yet. 
    <a href="{{ url_for('main.apply') }}" class="alert-link">Submit your first application</a>
</div>
{% endif %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Success Rate Chart
    const successRateCtx = document.getElementById('successRateChart').getContext('2d');
    new Chart(successRateCtx, {
        type: 'line',
        data: {
            labels: {{ applications|map(attribute='created_at')|map('strftime', '%Y-%m-%d')|list|tojson }},
            datasets: [{
                label: 'Success Probability',
                data: {{ applications|map(attribute='success_probability')|list|tojson }},
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1
                }
            }
        }
    });

    // Industry Distribution Chart
    const industryCtx = document.getElementById('industryChart').getContext('2d');
    const industryData = {{ applications|groupby('industry_type')|map('last')|list|tojson }};
    new Chart(industryCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(industryData),
            datasets: [{
                data: Object.values(industryData),
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 159, 64)'
                ]
            }]
        },
        options: {
            responsive: true
        }
    });
</script>
{% endblock %}
{% endblock %} 